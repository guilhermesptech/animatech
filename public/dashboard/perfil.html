<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil</title>
    <link rel="stylesheet" href="css/perfil.css">
    <script src="../js/sessao.js"></script>
</head>

<body
    onload="validarSessao(); retornarImagemPerfil(); exibirPodioDoUsuario(); exibirGenerosPreferidosDoUsuario(); exibirMesMaisAcessadoPeloUsuario();">
    <header>
        <nav class="container-navegacao">
            <div class="logotipo">
                <img src="../assets/logotipo.png" width="40px" alt="Logotipo">
            </div>
            <ul>
                <li><a href="inicio.html">Votatoon</a></li>
                <li><a href="dashboard.html">Gr√°ficos</a></li>
                <li><a href="perfil.html"><strong>Perfil</strong></a></li>
                <li><a onclick="limparSessao()">Sair</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section class="container-perfil">
            <div class="container-perfil-conteudo">
                <div class="container-foto-perfil">
                    <img src="" id="foto-perfil" alt="Foto de perfil" onclick="abrirEscolhaFotoPerfil()">
                </div>
                <div class="container-selecionar-foto-perfil" id="div-selecionar-foto-perfil">
                    <div class="selecionar-foto-perfil">
                        <span class="container-fechar" onclick="fecharEscolhaFotoPerfil()">‚ùå</span>
                        <h3>Escolha sua nova foto de perfil</h3>
                        <div class="lista-foto-perfil" id="div-lista-foto-perfil"></div>
                    </div>
                </div>
                <h3 id="b_usuario"></h3>
            </div>
        </section>
        <section class="container-desenhos-mais-curtidos">
            <h2>Ol√°,
                <span id="n_usuario"></span>!
            </h2>
            <p>Em alta üî•</p>
            <div class="container-podio">
                <div id="container-segundo-lugar" class="container-lugar segundo-lugar"></div>
                <div id="container-primeiro-lugar" class="container-lugar primeiro-lugar"></div>
                <div id="container-terceiro-lugar" class="container-lugar terceiro-lugar"></div>
            </div>
        </section>
        <section class="container-generos-mais-curtidos">
            <div class="grafico-generos-mais-curtidos">
                <p>G√™neros que voc√™ mais curte no momento!</p>
                <canvas id="graficoGenero"></canvas>
                <div class="indicadores-grafico">
                    <div class="kpis">
                        <div id="generoMaisVotado"></div>
                        <div id="totalDeVotos"></div>
                        <div id="mediaDeVotos"></div>
                    </div>
                </div>
            </div>
        </section>
        <section class="container-leitura-informacoes">
            <p>O que seus g√™neros favoritos dizem sobre voc√™:</p>
            <div id="container_titulo" class="container-titulo"></div>
            <div id="container_imagem_leitura_perfil" class="container-imagem-leitura-perfil"></div>
            <div id="container_leitura_perfil" class="container-leitura-perfil"></div>
        </section>
        <section class="container-meses-mais-acessados">
            <div class="grafico-meses-mais-acessados">
                <p>Que tal saber os meses em que voc√™ mais nos visitou?</p>
                <canvas id="graficoMeses"></canvas>
                <div class="indicadores-grafico">
                    <div class="kpis">
                        <div id="mesMaisAcessado"></div>
                        <div id="totalDeAcessos"></div>
                        <div id="mediaDeAcessos"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

    const imagens = [
        "imagens/perfil-masculino.png",
        "imagens/perfil-feminino.png"
    ];

    function retornarImagemPerfil() {

        fetch('/usuarios/retornarImagemPerfil', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                usuarioId: sessionStorage.ID_USUARIO
            })
        })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error("Erro ao retornar imagem de perfil");
                }
                return resposta.json();
            })
            .then(function (data) {
                document.getElementById('foto-perfil').src = data.imagem_url;
            })
            .catch(function (error) {
                alert(error.message);
            });
    }

    function abrirEscolhaFotoPerfil() {
        const lista = document.getElementById("div-lista-foto-perfil");
        lista.innerHTML = "";
        let resposta = "";

        for (let i = 0; i < imagens.length; i++) {
            let caminho = imagens[i];
            resposta += `<img src="${caminho}" onclick="atualizarImagemPerfil('${caminho}')">`
        }

        lista.innerHTML = resposta;
        document.getElementById("div-selecionar-foto-perfil").style.display = "flex";
    }

    function fecharEscolhaFotoPerfil() {
        document.getElementById("div-selecionar-foto-perfil").style.display = "none";
    }

    function atualizarImagemPerfil(caminho) {

        document.getElementById("foto-perfil").src = caminho;

        fecharEscolhaFotoPerfil();

        fetch('/usuarios/atualizarImagemPerfil', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                imagemUrl: caminho,
                usuarioId: sessionStorage.ID_USUARIO
            })
        }).then(function (response) {
            if (response.ok) {
                console.log('Perfil atualizado com sucesso!');
            } else {
                alert('Erro ao atualizar perfil');
            }
        });
    }

    function exibirPodioDoUsuario() {

        let usuarioId = sessionStorage.getItem("ID_USUARIO");

        fetch(`/desenhos/exibirPodioDoUsuario/${usuarioId}`)
            .then(function (resposta) {
                if (!resposta.ok) {
                    console.log("Erro ao buscar top 3 desenhos");
                }
                return resposta.json();
            })
            .then(function (desenhos) {
                if (desenhos.length === 3) {
                    document.getElementById('container-primeiro-lugar').innerHTML = `
                    <img src="${desenhos[0].imagem_url}" alt="Primeiro lugar" class="imagem-podio">
                    `;

                    document.getElementById('container-segundo-lugar').innerHTML = `
                    <img src="${desenhos[1].imagem_url}" alt="Segundo lugar" class="imagem-podio">
                    `;

                    document.getElementById('container-terceiro-lugar').innerHTML = `
                    <img src="${desenhos[2].imagem_url}" alt="Terceiro lugar" class="imagem-podio">
                    `;
                } else {
                    console.log("N√£o foram retornados 3 desenhos");
                }
            })
            .catch(function (erro) {
                console.log("Erro ao carregar o p√≥dio ", erro);
            });
    }

    function exibirGenerosPreferidosDoUsuario() {

        let usuarioId = sessionStorage.getItem("ID_USUARIO");
        let generoTopUm = "";
        let generoTopDois = "";

        fetch(`/desenhos/exibirOsGenerosPreferidosDoUsuario/${usuarioId}`)
            .then(function (resposta) {
                if (!resposta.ok) {
                    console.log("Erro ao buscar os g√™neros preferidos do usu√°rio")
                }
                return resposta.json();
            })
            .then(function (generos) {

                if (generos.length > 1) {

                    const labels = [];
                    const data = [];

                    let quantidadeDeVotos = 0;
                    let quantidadeTotalDeVotos = 0;
                    let quantidadeMediaDeVotos = 0;
                    let nomeDoGeneroMaisVotado = "";

                    generoTopUm = generos[0].nome;
                    generoTopDois = generos[1].nome;

                    for (let i = 0; i < generos.length; i++) {
                        labels.push(generos[i].nome);
                        data.push(Number(generos[i].total_votos));

                        if (Number(generos[i].total_votos) > quantidadeDeVotos) {
                            quantidadeDeVotos = Number(generos[i].total_votos);
                            nomeDoGeneroMaisVotado = generos[i].nome;
                        }
                        quantidadeTotalDeVotos += Number(generos[i].total_votos);
                    }

                    const generoMaisVotado = document.getElementById('generoMaisVotado');
                    generoMaisVotado.innerHTML = `‚≠ê G√™nero com mais votos: ${nomeDoGeneroMaisVotado} (${quantidadeDeVotos} votos)`;
                    const totalDeVotos = document.getElementById('totalDeVotos');
                    totalDeVotos.innerHTML = `üî• Quantidade total de votos: ${quantidadeTotalDeVotos}`;
                    const mediaDeVotos = document.getElementById('mediaDeVotos');
                    mediaDeVotos.innerHTML = `üìä Quantidade m√©dia de votos: ${(quantidadeTotalDeVotos / generos.length).toFixed(1)}`;

                    const grafico = document.getElementById('graficoGenero').getContext('2d');

                    new Chart(grafico, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Votos',
                                data: data,
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#00FF00', '#8A2BE2'],
                                borderColor: ['#FF6384', '#36A2EB', '#FFCE56', '#00FF00', '#8A2BE2'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });

                    if (generoTopUm == "Anime" && generoTopDois == "Infantil" || generoTopUm == "Infantil" && generoTopDois == "Anime") {
                        container_titulo.innerHTML = "Otaku de Pijaminha!"
                        container_leitura_perfil.innerHTML = "Voc√™ ama a cultura japonesa, mas tamb√©m adora reviver mem√≥rias da sua inf√¢ncia!";
                        document.getElementById('container_imagem_leitura_perfil').innerHTML = `
                        <img src="imagens/imagem_analise_perfil/infantil&anime.jpg">`;
                    }

                    if (generoTopUm == "Com√©dia" && generoTopDois == "Infantil" || generoTopUm == "Infantil" && generoTopDois == "Com√©dia") {
                        container_titulo.innerHTML = "Amante da divers√£o animada!"
                        container_leitura_perfil.innerHTML = "Voc√™ adora reviver momentos marcantes da sua inf√¢ncia dando boas risadas!";
                        document.getElementById('container_imagem_leitura_perfil').innerHTML = `
                        <img src="imagens/imagem_analise_perfil/infantil&comedia.jpg">`;
                    }
                }
            })
    }

    function exibirMesMaisAcessadoPeloUsuario() {

        let usuarioId = sessionStorage.getItem("ID_USUARIO");

        fetch(`/usuarios/exibirMesMaisAcessadoPeloUsuario/${usuarioId}`)
            .then(function (resposta) {
                if (!resposta.ok) {
                    console.log("Erro ao exibir os 5 meses mais acessados")
                }
                return resposta.json();
            })
            .then(function (acessos) {

                if (acessos.length > 0) {

                    const meses = [
                        'Janeiro',
                        'Fevereiro',
                        'Mar√ßo',
                        'Abril',
                        'Maio',
                        'Junho',
                        'Julho',
                        'Agosto',
                        'Setembro',
                        'Outubro',
                        'Novembro',
                        'Dezembro'
                    ];

                    const labels = [];
                    const data = [];

                    let quantidadeDeAcessos = 0;
                    let quantidadeTotalDeAcessos = 0;
                    let quantidadeMediaDeAcessos = 0;
                    let nomeDoMesMaisAcessado = "";

                    for (let i = 0; i < acessos.length; i++) {
                        labels.push(meses[acessos[i].mes - 1]);
                        data.push(acessos[i].total_acessos);

                        if (acessos[i].total_acessos > quantidadeDeAcessos) {
                            quantidadeDeAcessos = acessos[i].total_acessos;
                            nomeDoMesMaisAcessado = meses[acessos[i].mes - 1];
                        }
                        quantidadeTotalDeAcessos += acessos[i].total_acessos;
                    }

                    const mesMaisAcessado = document.getElementById('mesMaisAcessado');
                    mesMaisAcessado.innerHTML = `‚≠ê M√™s com mais acessos: ${nomeDoMesMaisAcessado} (${quantidadeDeAcessos} acessos)`;
                    const totalDeAcessos = document.getElementById('totalDeAcessos');
                    totalDeAcessos.innerHTML = `üî• Quantidade total de acessos: ${quantidadeTotalDeAcessos}`;
                    const mediaDeAcessos = document.getElementById('mediaDeAcessos');
                    mediaDeAcessos.innerHTML = `üìä Quantidade m√©dia de acessos: ${(quantidadeTotalDeAcessos / acessos.length).toFixed(1)}`;

                    const grafico = document.getElementById('graficoMeses').getContext('2d');

                    new Chart(grafico, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Acessos',
                                data: data,
                                backgroundColor: '#36A2EB',
                                borderColor: '#36A2EB',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 10,
                                    ticks: {
                                        stepSize: 1,
                                    }
                                }
                            }
                        }
                    });
                }
            })
    }

</script>